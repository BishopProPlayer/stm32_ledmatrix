# Отображение яркой области на светодиодной панели на основе громкости звука полученного от микрофона

## Задание:
Моделирование игры «Галага» с использованием светодиодной матричной платы с протоколом SPI

## 1. Изучение SPI
SPI — последовательный синхронный стандарт передачи данных в режиме полного дуплекса, предназначенный для обеспечения простого и недорогого высокоскоростного сопряжения микроконтроллеров и периферии. SPI также иногда называют четырёхпроводным интерфейсом.
### 1.1 Интерфейс SPI

![image](https://github.com/BishopProPlayer/stm32_ledmatrix/assets/137152870/4b3d4a7e-2307-4dcd-8c31-ce2093730ea6)

В SPI используются четыре цифровых сигнала:
* MOSI — выход ведущего, вход ведомого. Служит для передачи данных от ведущего устройства ведомому.
* MISO — вход ведущего, выход ведомого. Служит для передачи данных от ведомого устройства ведущему.
* SCLK или SCK — последовательный тактовый сигнал. Служит для передачи тактового сигнала для ведомых устройств.
* CS или SS — выбор микросхемы, выбор ведомого.
### 1.2 Прием и передача данных в SPI
![Screenshot of a comment on a GitHub issue showing an image, added in the Markdown, of an Octocat smiling and raising a tentacle.](https://upload.wikimedia.org/wikipedia/commons/b/bb/SPI_8-bit_circular_transfer.svg)

Процесс передачи обычно включает в себя два сдвиговых регистра фиксированного размера, например 8 бит, один сдвиговый регистр для ведущего и один сдвиговый регистр для ведомого. Абстрактно эти два регистра соединены кольцевым способом. Тогда процесс передачи будет включать в себя следующие этапы:

* Шаг 1: Вывод SS с соответствующим ведомым устройством, которое ведущее устройство хочет передавать/принимать, будет записан ведущим на низкий логический уровень.

* Шаг 2: Бит MSB будет передан первым. В течение одного тактового импульса и ведущий, и ведомый транслируют 1 бит и отправляют этот бит ведомому или ведущему устройству, который необходимо передать соответственно. Во время следующего тактового импульса на каждой принимающей стороне бит выбирается на линии и сохраняется как последний младший бит в сдвиговом регистре. После того, как все биты сдвигового регистра были вытолкнуты или приняты, ведущий и ведомый устройства завершили обмен значениями регистра. Если необходимо передать больше данных, сдвиговые регистры перезагружаются и описанный выше процесс повторяется.

* Шаг 3: По завершении ведущий прекращает инверсию часов и перестает выбирать вывод SS соответствующим ведомым устройством. Тогда вывод SS будет записан мастером на высокий логический уровень.
## 2. Светодиодный модуль P10
Изображение светодиодного модуля P10 показано на рисунке ниже.
![Screenshot of a comment on a GitHub issue showing an image, added in the Markdown, of an Octocat smiling and raising a tentacle.](https://led-ekb.ru/image/cache/data/moduli/P10_Single_Outdoor_Module-600x750.jpg)
![Screenshot of a comment on a GitHub issue showing an image, added in the Markdown, of an Octocat smiling and raising a tentacle.](https://habrastorage.org/r/w1560/files/4ee/b75/b14/4eeb75b1445b4b3893f7a8c4d4afeefe.jpg)

Принципиальная схема работы светодиодной панели представлена ​​на рисунке ниже.
![Screenshot of a comment on a GitHub issue showing an image, added in the Markdown, of an Octocat smiling and raising a tentacle.](https://habrastorage.org/files/67b/bb8/862/67bbb8862780441586c79c3825618402.gif)

Подключение к матрице в рамках лабораторной работы будет осуществляться путём подключения сигнальных проводов от платы STM32 к специальному кабелю, установленному в крайний левый слот. Распиновку разъёма матрицы: 
![Screenshot of a comment on a GitHub issue showing an image, added in the Markdown, of an Octocat smiling and raising a tentacle.](https://habrastorage.org/r/w1560/files/0bc/02e/643/0bc02e6435c04856a93533bdb10f40e3.jpg)

Там:
* A и B - необходим для переключения между строками
* nOE - отвечает за запуск / отключение матрицы 
* SCK - канал для синхронизации частот работы переферии 
* MOSI - канал передачи данных
* SCLK - канал подтверждения конца загрузки байта данных

Логика обновления четверти экрана выглядит следующим образом:
1. Выдаём по SPI данные для сдвиговых регистров. Для одной матрицы 32x16 это 16 байт (16 8-битных регистров).
1. Устанавливаем лог. 0 на ножке nOE.
1. Устанавливаем лог. уровни на ножках A и B в соответствии с обновляемой группой светодиодов (одной из четырёх). Это подаёт +5В на аноды светодиодов выбранной группы.
1. Выдаём на ножку SCLK короткий положительный импульс. Это подаёт землю на катоды светодиодов в соответствии с загруженными в регистры байтами.
1. Устанавливаем лог. 1 на ножке nOE. При этом четверть экрана (одна группа светодиодов) загорается и горит до следующего обновления следующей группы светодиодов.

Повторяем пункты 1-5 с постоянным периодом.

## 3. Настрйока микроконтроллера STM32
На изображении ниже можно увидеть изображение микроконтроллера со всеми активными выводами.

![image](https://github.com/BishopProPlayer/stm32_ledmatrix/assets/137152870/2f2b326d-24fc-4a86-9f11-ec83782f306f)


Список используемых пинов: 
Список используемых пинов: 
* PC3 - A - отвечает за выбор строки для загрузки данных
* PС0 - B - отвечает за выбор строки для загрузки данных
* PA6 - SCLK - канал для прменения полученных данных (необходимо подать высокий и следом сразу низкий сигнал)
* PA4 - nOE - отвечает за включение / выключение панели
* PA5 - SPI1_SCK - канал для тактирования ведомого устройства от ведущего
* PA7 - SPI1_MOSI -канал для передачи данных
* PB3 - направление самолета вправо
* PB5 - направление самолета влево
* PB4 - стрельба с самолетов

## 4. Результат работы
На фото симуляция игры галага на светодиодной матричной доске.
![20231229_161012](https://github.com/BishopProPlayer/stm32_ledmatrix/assets/137152870/821f4599-29f6-448f-b725-07a17e76c71b)
![20231229_161013](https://github.com/BishopProPlayer/stm32_ledmatrix/assets/137152870/7b6dec33-f99d-4d09-acac-73da90185067)






